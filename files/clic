#!/bin/bash

# NAMESCHEME is the name of the head node, and all NAMESCHEMEXX are compute nodes.

TWIDDLE_TIME=20
SLEEP_TIME=10

mainLoop() {
	while [ "true" ]; do
		echo "Doing stuff"
		# Queued and running jobs are one line each containing the job number
		rJobs=`qstat -r | tail -n+6 | awk '{print $1}'`
		qJobs=`qstat -i | tail -n+6 | awk '{print $1}'`

		for jobNum in $qJobs; do
			if [ -z ${job[$jobNum]} ]; then job[$jobNum]=0; fi
			job[$jobNum]=`expr ${job[$jobNum]} + $SLEEP_TIME`
			if [ "${job[$jobNum]}" -gt "$TWIDDLE_TIME" ]; then
				# Time to boot up another compute node
				echo "I want to make another node!"
			fi
		done

		if [ -z "$qJobs" ] && [ "`sinfo -h -o %A | cut -d '/' -f 2`" -gt "0" ]; then
			# Node(s) sit idle...
			if [ -z "$emptyTime" ]; then
				emptyTime=`uptime`
			elif [ "$(expr $(uptime) - $emptyTime)" -gt "$TWIDDLE_TIME" ]; then
				# ...and have for some time
				echo "I want to delete a node!"
				emptyTime=""
			fi
		elif [ -n "$emptyTime" ]; then
			# Clean up
			emptyTime=""
		fi
		
		sleep $SLEEP_TIME
	done
}

uptime() {
	cat /proc/uptime | awk '{print $1}' | cut -d '.' -f 1 # In seconds, rounded down
}

if [ "`hostname`" == "NAMESCHEME" ]; then
        # do head node stuff
        echo "Starting slurmctld.service"
        systemctl start slurmctld.service
	mainLoop &
else
        # do compute node stuff
        #echo "NAMESCHEME:/etc/slurm            /etc/slurm              nfs     ro,hard,intr    0 0" | sudo tee --append /etc/fstab > /dev/null
        #echo "NAMESCHEME:/etc/munge            /etc/munge              nfs     ro,hard,intr    0 0" | sudo tee --append /etc/fstab > /dev/null
        #echo "NAMESCHEME:/home                 /home                   nfs     rw,hard,intr    0 0" | sudo tee --append /etc/fstab > /dev/null
        sudo mount NAMESCHEME:/etc/slurm /etc/slurm --ro
        sudo mount NAMESCHEME:/etc/munge /etc/munge --ro
	sudo mount NAMESCHEME:/home /home --rw
        echo "Starting slurmd.service"
        systemctl start slurmd.service
fi
