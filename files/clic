#!/bin/bash

# NAMESCHEME is the name of the head node, and all NAMESCHEMEXX are compute nodes.

TWIDDLE_TIME=20
SLEEP_TIME=10
MAX_NODE_NUM=99

mainLoop() {
	while [ "true" ]; do
		# Queued and running jobs are one line each containing the job number
		rJobs=`qstat -r | tail -n+6 | awk '{print $1}'`
		qJobs=`qstat -i | tail -n+6 | awk '{print $1}'`

		nodesWanted=0
		nodesUp=0
		nodesBooting=0
		for node in $(seq -w 1 $MAX_NODE_NUM); do
			if [ "`state $node`" == "R" ]; then
				nodesUp=`expr $nodesUp + 1`
			elif [ "`state $node`" == "C" ]; then
				nodesBooting=`expr $nodesBooting + 1`
			fi
		done
		for jobNum in $qJobs; do
			# Keep track of time jobs have been queued
			if [ -z ${job[$jobNum]} ]; then job[$jobNum]=0; fi
			job[$jobNum]=`expr ${job[$jobNum]} + $SLEEP_TIME`
			# Determine if we need another node
			if [ "${job[$jobNum]}" -gt "$TWIDDLE_TIME" ]; then
				nodesWanted=`expr $nodesWanted + 1`
			fi
		done
		# If we have a queued job but no up nodes, we'll want to make one without waiting
		if [ -n "$qJobs" ] && [ "$nodesUp" -eq 0 ] && [ "$nodesBooting" -eq 0 ] && [ "$nodesWanted" -eq 0 ]; then
			nodesWanted=1
		fi

		echo "Nodes wanted: $nodesWanted, Nodes up: $nodesUp, Nodes booting: $nodesBooting"
		# Check that the nodes wanted aren't currently booting (nodesWanted + jobsRunning > nodesUp)
		nodesWanted=$((($nodesWanted - $nodesBooting + 1) / 2))
		create $nodesWanted

		# Check for nodes to delete
		numIdle=`numIdle`
		if [ -z "$qJobs" ] && [ "$numIdle" -gt "0" ]; then
			# Node(s) sit idle...
			if [ -z "$emptyTime" ]; then
				emptyTime=`uptime`
			elif [ "$(expr $(uptime) - $emptyTime)" -gt "$TWIDDLE_TIME" ]; then
				# ...and have sat idle for some time
				numToDelete=$((($numIdle + 1) / 2))
				delete $numToDelete
				emptyTime=""
			fi
		elif [ -n "$emptyTime" ]; then
			# Clean up
			emptyTime=""
		fi

		# Book keeping
		# ID : "<C|R|D> uptime when state was entered"
		# C=creating, R=running, D=deleting
		# Null string for deleted nodes
		nodenamesUp=`upNodes`
		for node in $(seq -w 1 $MAX_NODE_NUM); do
			if [ -n "`grep NAMESCHEME$node <<< $nodenamesUp`" ]; then
				# Node is running
				if [ "`state $node`" == "C" ]; then
					# Node was creating
					setState $node R
				elif [ -z "`state $node`" ]; then
					# Node isn't registered. Maybe the script was restarted?
					echo "ERROR: Encountered unregistered node, subsuming into cluster"
					setState $node R
				fi
			elif [ "`state $node`" != "C" ]; then
				# Node was deleted
				if [ "`state $node`" == "R" ]; then
					# That deletion was unexpected.
					echo "ERROR: Node deleted outside of clic!"
				fi
				setState $node ""
			fi
		done
		
		sleep $SLEEP_TIME
	done
}

uptime() {
	cat /proc/uptime | awk '{print $1}' | cut -d '.' -f 1 # In seconds, rounded down
}

numIdle() {
	num="`sinfo -h -o %A | cut -d '/' -f 2`"	
	if [ -z "$num" ]; then
		echo 0
	else
		echo $num
	fi
}

upNodes() {
	gcloud compute instances list | tail -n+2 | awk '{print $1}'
}

state() {
	node="`echo $1 | sed 's/^0*//'`"
	echo ${nodes[$node]} | awk '{print $1}'
}

setState() {
	node="`echo $1 | sed 's/^0*//'`"
	state="$2"
	if [ -n "$state" ]; then
		nodes[$node]="$state `uptime`"
	else
		nodes[$node]=""
	fi
}

create() {
	numToCreate=$1
	# Determine the next node name to use
	for i in `seq 1 $numToCreate`; do
		for num in $(seq -w 1 $MAX_NODE_NUM); do
			if [ -z "`state $num`" ]; then
				setState $num C
				echo "Creating NAMESCHEME$num"
				gcloud compute disks create NAMESCHEME$num --size 10 --source-snapshot NAMESCHEME &> /dev/null &&
				gcloud compute instances create NAMESCHEME$num --machine-type "n1-standard-1" --disk "name=NAMESCHEME$num,device-name=NAMESCHEME$num,mode=rw,boot=yes,auto-delete=yes" &> /dev/null &
				break
			fi
		done
	done
}

delete() {
	numToDelete=$1
	idleNodes="`sinfo -o "%t %n" | grep "idle" | awk '{print $2}'`"
	for i in `seq 1 $numToDelete`; do
		for num in $(seq -w 1 $MAX_NODE_NUM); do
			if [ -n "`grep "NAMESCHEME$num" <<< "$idleNodes"`" ] && [ "`state $num`" == "R" ]; then
				setState $num D
				echo "Deleting NAMESCHEME$num"
				echo Y | gcloud compute instances delete NAMESCHEME$num &> /dev/null &
				break
			fi	
		done
	done
}

if [ "`hostname`" == "NAMESCHEME" ]; then
        # do head node stuff
        echo "Starting slurmctld.service"
        systemctl start slurmctld.service
	zone=`gcloud compute instances list | grep "$(hostname) " | awk '{print $2}'`
	echo "Configuring gcloud for zone: $zone"
	gcloud config set compute/zone $zone
	mainLoop &
else
        # do compute node stuff
        #echo "NAMESCHEME:/etc/slurm            /etc/slurm              nfs     ro,hard,intr    0 0" | sudo tee --append /etc/fstab > /dev/null
        #echo "NAMESCHEME:/etc/munge            /etc/munge              nfs     ro,hard,intr    0 0" | sudo tee --append /etc/fstab > /dev/null
        #echo "NAMESCHEME:/home                 /home                   nfs     rw,hard,intr    0 0" | sudo tee --append /etc/fstab > /dev/null
        sudo mount NAMESCHEME:/etc/slurm /etc/slurm --ro
        sudo mount NAMESCHEME:/etc/munge /etc/munge --ro
	sudo mount NAMESCHEME:/home /home --rw
        echo "Starting slurmd.service"
        systemctl start slurmd.service
fi
