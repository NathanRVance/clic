#!/bin/bash

export CLIC_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

usage() {
        echo "Usage:"
	echo "-n --namescheme <name>   use <name> as the base name for cloud instances"
	echo "-u --user <name>         set up user account <name> on cloud computers for use with clic"
	echo "-c --cloud               installing to a cloud computer"
	echo "-s                       scripted, don't ask for confirmation"
	echo "--skip_slurm             don't install slurm on this machine"
	echo "-h --help                print this help message"
}

export user=`whoami`
export namescheme=`hostname`
export cloud=false
export script=false
export skip_slurm=false
ARGS=`getopt -n clic-install -o hscn:u: --long help,cloud,skip_slurm,namescheme:,user: -- "$@"`
if [ $? != 0 ] ; then
        usage
        exit 1
fi
eval set -- "$ARGS"
while true; do
        case $1 in
                -h | --help)
                        usage
                        exit 0
                        ;;
		-s)
			export script=true;
			shift
			;;
                -c | --cloud)
                        export cloud=true
                        shift
                        ;;
                -n | --namescheme)
                        export namescheme="$2"
                        shift 2
                        ;;
                -u | --user)
                        export user=$2
                        shift 2
                        ;;
		--skip_slurm)
			export skip_slurm=true
			shift
			;;
                --)
                        shift
                        break
                        ;;
                *)
                        break
                        ;;
        esac
done

if [ "`hostname`" == "$namescheme" ] && [ -n "`curl -s 'http://metadata/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip' -H 'X-Google-Metadata-Request: True'`" ]; then
	# A bit of a hack, but this api request only returns a non-empty string if run from within the cloud
	cloud=true
fi

if ! $script; then
	echo -n "Installing clic using "
	if $cloud; then
		echo -n "this cloud instance ($namescheme) as the basis for both the head and compute nodes."
	else
		echo -n "the google cloud instance named $namescheme as the basis for all compute nodes. The instance $namescheme must be currently running and already have any desired computational software installed to it."
	fi
	echo " Press ENTER to continue, or CTRL-c to exit."
	read ans
fi

if [ -n "`uname -a | grep -i Debian`" ]; then
   OS="debian"
elif [ -n "`uname -a | grep -i ubuntu`" ]; then
   OS="ubuntu"
elif [ -e "/etc/redhat-release" ]; then
   OS="centos"
else
   echo "Unidentified OS! Exiting."
   exit
fi
echo "Installing for $OS"

command -v gcloud >/dev/null 2>&1 || $CLIC_ROOT/scripts/$OS/setup_gcloud
$CLIC_ROOT/scripts/common/setup_gcloud

if ! $skip_slurm; then
	$CLIC_ROOT/scripts/$OS/install_slurm
fi	
$CLIC_ROOT/scripts/common/install_clic
source ~/.bashrc
if [ "$cloud" == false ]; then
	$CLIC_ROOT/scripts/common/create_cloud_snapshot
	echo "Please ensure that tcp ports 6817 (slurm) and 22 (ssh) are allowed through the firewall to this machine."
elif [ "$script" == false ]; then
	echo "Please stop this instance, take a snapshot of it, and name the snapshot \"$namescheme\". Once that is done, you can start this instance again and use it as the head node."
fi
