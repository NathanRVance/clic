#!/bin/bash

echo "Using $namescheme as the base name for the cluster"

#Install clic modules
sudo su - -c "pip3 install $CLIC_ROOT/src --upgrade"

#Run some of them
source ~/.bashrc
if ! $cloud; then
	sudo clic-synchosts
fi
sudo clic-copyid --generate --append -u `whoami` $user `whoami`

#Create a config file
sudo mkdir /etc/clic/
echo -e "\n/etc/clic/clic.conf:"
cat $CLIC_ROOT/files/clic.conf | sed "s/NAMESCHEME/$namescheme/g" | sed "s/CLOUD/$cloud/g" | sed "s/USER/$user/g" | sudo tee /etc/clic/clic.conf

#Create an example init script
echo -e "\n/etc/clic/example.sh:"
echo "#!/bin/bash
# This script dumps this machine's configuration into a file in /tmp
echo \"cpus: \$0\" >> /tmp/example.sh.out
echo \"disksize: \$1\" >> /tmp/example.sh.out
echo \"memory: \$2\" >> /tmp/example.sh.out" | sudo tee /etc/clic/example.sh
sudo chmod +x /etc/clic/example.sh

#And a readme
echo -e "\n/etc/clic/README:"
echo "
When clic-initnode is run, either manually or by clic, all executable files in this
directory are copied to the node being initialized and run in shell expansion order.
These files will be executed with command line arguments: cpus, disksize, memtype." | sudo tee /etc/clic/README

#Create a service to start the clic daemon
echo -e "\n/etc/systemd/system/clic.service:"
path="`which clic`"
cat $CLIC_ROOT/files/clic.service | sed "s&PATH&$path&g" | sudo tee /etc/systemd/system/clic.service

sudo systemctl enable clic.service
sudo systemctl restart clic.service
