#!/bin/bash

echo "Using $namescheme as the base name for the cluster"

#Install some python stuff that clic uses
sudo pip3 install rpyc
sudo pip3 install Flask
sudo pip3 install ipgetter

#Create a daemon that runs clic
echo -e "\n/usr/bin/clic:"
cat $CLIC_ROOT/files/clic | sudo tee /usr/bin/clic
sudo chmod +x /usr/bin/clic

#Move helper scripts into place
echo -e "\n/usr/bin/clic-sync-hosts:"
cat $CLIC_ROOT/files/clic-sync-hosts | sudo tee /usr/bin/clic-sync-hosts
sudo chmod +x /usr/bin/clic-sync-hosts
sudo clic-sync-hosts

echo -e "\n/usr/bin/clic-nodesup:"
cat $CLIC_ROOT/files/clic-nodesup | sed "s/USER/$user/g" | sed "s&KEY&/home/`whoami`/.ssh/id_rsa&g" | sudo tee /usr/bin/clic-nodesup
sudo chmod +x /usr/bin/clic-nodesup

echo -e "\n/usr/bin/clic-init-node:"
cat $CLIC_ROOT/files/clic-init-node | sudo tee /usr/bin/clic-init-node
sudo chmod +x /usr/bin/clic-init-node

echo -e "\n/usr/bin/clic-mount:"
cat $CLIC_ROOT/files/clic-mount | sudo tee /usr/bin/clic-mount
sudo chmod +x /usr/bin/clic-mount

echo -e "\n/usr/bin/clic-copy-id:"
cat $CLIC_ROOT/files/clic-copy-id | sudo tee /usr/bin/clic-copy-id
sudo chmod +x /usr/bin/clic-copy-id
sudo clic-copy-id --append -u `whoami` $user `whoami`

#Create a service to start the clic daemon
echo -e "\n/etc/systemd/system/clic.service:"
if $cloud; then
	cat $CLIC_ROOT/files/clic.service | sed "s/CLOUD/--cloud/g" | sed "s/USER/$user/g" | sed "s/NAMESCHEME/$namescheme/g" | sudo tee /etc/systemd/system/clic.service
else
	cat $CLIC_ROOT/files/clic.service | sed "s/CLOUD //g" | sed "s/USER/$user/g" | sed "s/NAMESCHEME/$namescheme/g" | sudo tee /etc/systemd/system/clic.service
fi
sudo systemctl enable clic.service
sudo systemctl restart clic.service
