#!/bin/bash

# One way or another, install git
gcloud compute ssh $user@$namescheme --command="sudo yum -y install git || sudo apt -y install git"
# Install slurm
gcloud compute ssh $user@$namescheme --command="git clone https://github.com/nathanrvance/clic && ./clic/install --cloud"
# Copy over munge key
sudo gcloud compute scp /etc/munge/munge.key $user@$namescheme:.
gcloud compute ssh $user@$namescheme --command="sudo rm /etc/munge/munge.key && sudo cp /home/$user/munge.key /etc/munge/ && sudo chown munge:munge /etc/munge/munge.key && sudo chmod 400 /etc/munge/munge.key"
# Copy over slurm.conf
sudo gcloud compute scp /etc/slurm/slurm.conf $user@$namescheme:.
gcloud compute ssh $user@$namescheme --command="sudo rm /etc/slurm/slurm.conf && sudo cp /home/$user/slurm.conf /etc/slurm/ && sudo chown root:root /etc/slurm/slurm.conf && sudo chmod 644 /etc/slurm/slurm.conf"

# Stop and snapshot the instance
gcloud compute instances stop $namescheme
gcloud compute disks snapshot $namescheme --snapshot-names=$namescheme

echo "You are now free to delete the instance named $namescheme if you desire."
